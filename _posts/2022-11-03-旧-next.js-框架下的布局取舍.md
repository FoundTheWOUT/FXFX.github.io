---
title: 旧 Next.js 框架下的布局取舍
date: 2022-11-03
tags:
  - Layout
  - React
  - Next.js 13
---

在 [bilibili-evolved-doc 改造记录 - 异步 MarkDown 加载](/bilibili-evolved-doc-改造记录---异步-markdown-加载) 中记录了把文档内容部分改造成异步加载的同时，解决了 Next 下布局的问题。
但在网站实际运行一段时间后，依然发现不小问题。

1. 异步加载只是表现于首屏加载，在切换路由时并不会显示过渡动画
2. SSG 基础结构遭到破坏，首屏加载闪烁

这些问题的出现可以说是由于 Next.js（13 以前） 的路由设计所导致的。换句话说，Next.js 路由模式的设计缺陷导致了 Next.js 用户需要写一堆犄角旮旯的代码以实现想要的效果。

### 原始模式

```text
pages
|-- index.tsx
|-- docs
|   |-- Foo.md
```

借助 `@mdx/loader` 我们在遇到 Foo.md 时将去转换为 tsx，作为页面提供给 next.js。若我们需要给 `docs` 目录下页面套用统一的布局时，可以按照 Next.js 文档的方式暴露出一个方法，然后在根获取到这个组件。

```text
# This is Foo.md

export const getLayout= (props) => <Layout {...props}></Layout>
```

如果你不想每个文件都手写一次这些代码，当然可以写一个 `mdx` 插件往页面内注入代码。代价是你将失去灵活切换布局的能力，而且可能你还需要花不少的时间学习如果编写插件。
可以发现无论是手写每个文件的布局还是通过插件注入代码都会令这个*简单*的过程变得非常繁琐。

### 正确的路由模式

为什么我说*简单*~~（其实并不简单）~~，是因为在 `react-router` 的世界里根本没有这个问题。

```json
[
  {
    "path": "/docs",
    "element": {}, // <- docs 下的布局
    "children": []
  },
  {
    "path": "/", // <- 根页面
    "element": {}
  }
]
```

你甚至可以在 `docs` 下根据某些规则而套用不同的布局。

而在 Next.js 中不行则是因为其将一个网站假设成了一棵树，所有的路径都是 `/` 的子节点或者孙子节点。可显示情况中，网站的目录往往是一个森林，或者说多根树，也就是和例子中一样， `/` 和 `/docs` 有可能是同级的。正是因为 Next.js 的路由模式中缺失了这种路径组织方式，导致了原始模式下两难的场景。

### Hacker 模式

当然，聪明的开发者们没有被 Next.js 这种蹩脚的路由模式绊倒。在社区中存在着一种利用动态路由的解决方案。也是 [bilibili-evolved-doc 改造记录 - 异步 MarkDown 加载](/bilibili-evolved-doc-改造记录---异步-markdown-加载) 一文中采用的方案。这里就不详细介绍了。这里主要谈谈这种方案的缺点，或者说不方便的地方。

- 你需要正确的编写 `getStaticPaths` 以使得 SSG（SSR） 模式正常的运行（这就是导致一开始问题 2 的原因）
- 你可能需要编写繁琐 `getStaticProps` 以或者你想要的内容

尤其是后者，`getStaticProps` 在服务端运行，我们需要格外的注意某些代码（库），因为它们依赖**浏览器**环境。而且，客户端于服务端之间只能互相传递序列化后的数据，这意味着我们不能**直接**返回一个组件。尽管这样非常的直观易懂，但我们不能这样做，我们必须在服务端处理好这些组件再返回给客户端。

### 究极的解决方案

当然是重构拉！这并不是在开玩笑，[Next.js 13](https://beta.nextjs.org/docs/routing/pages-and-layouts) 更新中的重要的新功能就是路由模式和布局结构的改。
